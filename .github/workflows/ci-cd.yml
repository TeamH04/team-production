name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '24.x'
  GO_VERSION: '1.24.11'

jobs:
  # ----- Quality Checks (全体) -----
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-dependency-path: '**/pnpm-lock.yaml'

      - name: Lint
        run: pnpm run lint

      - name: Format check
        run: pnpm run format:check

      - name: Type check
        run: pnpm run type-check || echo "Type check not configured"

  # ----- Security & Dependency Audit -----
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    # mainブランチへのpushとPRのみ実行
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node + pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache-dependency-path: '**/pnpm-lock.yaml'

      - name: Run npm security audit
        run: |
          pnpm audit --dev --audit-level moderate || echo "Some vulnerabilities found"

      - name: Setup Go
        uses: ./.github/actions/setup-go
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: apps/backend/go.sum
          working-directory: apps/backend

      - name: Run Go security check (gosec)
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          cd apps/backend
          $HOME/go/bin/gosec -no-fail -fmt sarif -out ../../results.sarif ./...

      - name: Upload SARIF file
        if: hashFiles('results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
